<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-input/paper-input-container.html">


<dom-module id="cbn-select">
    <template>
        <style>
            :host {
                display: block;
            }

            #filter {
                border: none;
                margin-bottom: 6px;
                position: relative;
                display: inline-block;
                width: 100%;
                height: 20px;
                outline: none;
            }

            .tari {
                border: none;
                position: absolute;
                background-color: whitesmoke;
                display: none;
                z-index: 100;
                cursor: pointer;
            }

            .tariSelectate {
                background-color: darkgrey;
            }

            .displayTari {
                display: block;
            }

            .arrow-left {
                width: 0;
                height: 0;
                border-top: 5px solid transparent;
                border-bottom: 5px solid transparent;
                border-right: 10px solid black;
                z-index: 1;
                position: absolute;
                right: 12px;
                top: -24px;
                transition: transform 0.5s;
            }

            .arrow-down {
                transform: rotate(-90deg);
            }

            .spanPrincipal {
                position: relative;
                padding-right: 30px;
                background-color: #E7E7E7;
                border-radius: 8px;
                display: inline-block;
                height: 20px;
                z-index: 1;
                white-space: nowrap;
            }

            .closeBtn {
                flex-shrink: 0;
                width: 20px;
                height: 16px;
                margin-left: 3px;
                cursor: pointer;
                position: absolute;
                top: 2px;
                right: 0px;
            }

            .container {
                display: flex;
                flex-direction: row;
            }

            .fiecareDiv {
                padding: 5px 10px;
            }
            .linieLabel {
                top: -27px;
            }
            input.my-input {
                @apply --paper-input-container-shared-input-style;
            }
        </style>

        <paper-input-container always-float-label="[[propInput]]">
            <label class="label" slot="label">[[label]]</label>
        <div class="container" slot="input" style="position:relative;">

            <template is="dom-repeat" items="{{_value}}">
              <span class="spanPrincipal" for="spanPrincipal">
                        <span id="spanPrincipal" style="padding-left: 5px;">[[item.label]]</span>
                        <iron-icon class="closeBtn" icon="icons:backspace" on-click="delete"></iron-icon>
              </span>
            </template>
            <input class="my-input" id="filter" type="text" for="tari" on-input="filter" on-click="styleDisplay" on-keydown="keyCode" on-blur="displayNone"/>

        </div>
            <div slot="input" style="position:relative;">
                <div class="arrow-left"></div>
            </div>
        <div slot="input" class="tari" on-mouseover="changeColor" on-mouseout="colorBack">
            <template is="dom-repeat" items="{{elemRamase}}">
                <div class="fiecareDiv" on-mousedown="selectFunction">[[item.label]]</div>
            </template>
        </div>
        </paper-input-container>

    </template>

    <script>
        /**
         * `cbn-select`
         *
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class CbnSelect extends Polymer.Element {
            static get is() {
                return 'cbn-select';
            }

            static get properties() {
                return {

                    label: {
                        type: String

                    },
                    name: {
                        type: String
                    },
                    indexTabel: {
                        type: Number,
                        value: -1
                    },

                    options: {
                        type: Array,
                        value: function () {
                            return []
                        },
                        observer: "optionsChange"
                    },

                    elemRamase: {
                        type: Array,
                        value: function () {
                            return []
                        }
                    },

                    value: {
                        type: Array,
                        value: function () {
                            return []
                        },

                        observer: "valueChange",

                    },

                    _value: {
                        type: Array,
                        value: function () {
                            return []
                        },
                        notify: false,
                        readOnly: false
                    },

                    memArray: {
                        type: Array,
                        value: function () {
                            return []
                        }
                    },

                    multiple: {
                        type: Boolean,
                        value: false
                    },

                    combo: {
                        type: Boolean,
                        value: false
                    },

                    freetext: {
                        type: Boolean,
                        value: false
                    },
                    mobile: {
                        type: Boolean,
                        value: false
                    },

                    itemLabelProperty: {
                        type: String,
                        value: "label"
                    },
                    itemValueProperty: {
                        type: String,
                        value: "value"
                    },
                    required: {
                        type: Boolean,
                        value: false
                    },
                    propInput: {
                        type: Boolean,
                        value:false
                    }
                };
            }

            validate() {
                return !(this.required && this.value.length <= 0);
            }

            valueChange(event) {
                this._value = [];
                if (this.value instanceof Array) {
                    for (let i = 0; i < this.value.length; i++) {
                        let position = 0;
                        if ((this.multiple === true || this.combo === false) && this.mobile === false) {
                            position = this._value.length;
                        }
                        if (this.multiple === false && this.combo === true && this.mobile === false) {
                            position = 0;
                        }
                        if (typeof this.value[i] === "string") {
                            let found = false;
                            for (let j = 0; j < this.memArray.length; j++) {
                                if (this.value[i] === this.memArray[j].value) {
                                    this.splice("_value", position, 0, {
                                        label: this.memArray[j].label,
                                        value: this.memArray[j].value
                                    });
                                    found = true;
                                }
                            }
                            if (this.freetext && !found) {
                                this.splice("_value", position, 0, {
                                    label: this.value[i],
                                    value: this.value[i]
                                });
                            }
                        } else {
                            let itemValueProp = "value";
                            let itemLabelProp = "label";

                            if (this.itemLabelProperty !== null && this.value[i].hasOwnProperty(this.itemLabelProperty)) {
                                itemLabelProp = this.itemLabelProperty;
                            }
                            if (this.itemValueProperty !== null && this.value[i].hasOwnProperty(this.itemValueProperty)) {
                                itemValueProp = this.itemValueProperty;
                            }
                            this.splice("_value", position, 0, {
                                "label": this.value[i][this.itemLabelProperty],
                                "value": this.value[i][this.itemValueProperty]
                            });
                        }
                    }
                } else {
                    if (typeof this.value === "string") {
                        let found = false;
                        for (let j = 0; j < this.memArray.length; j++) {
                            if (this.value === this.memArray[j].value) {
                                this.splice("_value", 0, 0, {
                                    label: this.memArray[j].label,
                                    value: this.memArray[j].value
                                });
                                found = true;
                            }
                        }
                        if (this.freetext && !found) {
                            this.splice("_value", 0, 0, {
                                label: this.value,
                                value: this.value
                            });
                        }
                    } else {
                        let itemValueProp = "value";
                        let itemLabelProp = "label";

                        if (this.itemLabelProperty !== null && this.value.hasOwnProperty(this.itemLabelProperty)) {
                            itemLabelProp = this.itemLabelProperty;
                        }
                        if (this.itemValueProperty !== null && this.value.hasOwnProperty(this.itemValueProperty)) {
                            itemValueProp = this.itemValueProperty;
                        }
                        this.splice("_value", position, 0, {
                            "label": this.value[this.itemLabelProperty],
                            "value": this.value[this.itemValueProperty]
                        });
                    }
                }


            }

            throwEvent(reset) {
                let value = "";
                if (this._value === undefined || this._value === null) {
                    if (this.multiple) {
                        value = [];
                    } else {
                        value = "";
                    }
                } else if (this.multiple) {
                    let val=[];
                    for(let i=0;i<this._value.length;i++){
                        val.push(this._value[i].value);
                    }
                    value = val;
                } else if (this._value.length > 0) {
                    value = this._value[0].value;
                } else {
                    value = "";
                }
                if(this._value.length !== 0 || this.$.filter.value !== ""){
                    this.propInput = true;
                }else{
                    this.propInput = false;
                }
                if(reset!==false) {
                    this.value=value;
                }

                this.dispatchEvent(new CustomEvent("selected-changed", {
                    bubbles: true,
                    composed: true,
                    detail: {
                        value: value
                    }
                }));
            }

            optionsChange() {
                let memArrayNew = [];
                for (let i = 0; i < this.options.length; i++) {
                    if (typeof this.options[i] === 'string') {
                        memArrayNew[i] = {"label": this.options[i], "value": this.options[i]};
                    } else {
                        memArrayNew[i] = JSON.parse(JSON.stringify(this.options[i]));
                        if (this.itemValueProperty !== null && this.options[i].hasOwnProperty(this.itemValueProperty)) {
                            memArrayNew[i]["value"] = this.options[i][this.itemValueProperty];
                        }
                        if (this.itemLabelProperty !== null && this.options[i].hasOwnProperty(this.itemLabelProperty)) {
                            memArrayNew[i]["label"] = this.options[i][this.itemLabelProperty];
                        }
                    }
                }

                this.memArray = memArrayNew;
                this.elemRamase = JSON.parse(JSON.stringify(memArrayNew));
                this.orderList();
            }

            orderList() {
                this.elemRamase.sort(
                    function (a, b) {
                        return a.label.toLowerCase().localeCompare(b.label.toLowerCase());
                    }
                );
            }


            styleDisplay() {
                if(this._value.length !== 0 || this.$.filter.value !== ""){
                    this.propInput = true;
                }else{
                    this.propInput = false;
                }
                if (this.indexTabel === -1) {
                    this.indexTabel = 0;
                }
                this.shadowRoot.querySelector(".tari").classList.add("displayTari");
                this.shadowRoot.querySelector(".arrow-left").classList.add("arrow-down");
                    setTimeout(function () {
                        if (this.elemRamase.length > this.indexTabel && this.shadowRoot.querySelector(".tari div:nth-of-type(" + (this.indexTabel + 1) + ")") !== null) {
                            this.shadowRoot.querySelector(".tari div:nth-of-type(" + (this.indexTabel + 1) + ")").classList.add("tariSelectate");
                        }
                    }.bind(this));
            }

            displayNone(event) {
                this.shadowRoot.querySelector(".arrow-left").classList.remove("arrow-down");
                this.shadowRoot.querySelector(".tari").classList.remove("displayTari");
                this.indexTabel = -1;
            }

            getFocus(event) {
                event.path[0].parentNode.querySelector("#filter").focus();
            }

            changeColor(event) {
                for (let i = 0; i < this.elemRamase.length; i++) {
                    if (event.path[0].innerHTML === this.elemRamase[i].label) {
                        if (this.indexTabel !== -1) {
                            this.shadowRoot.querySelector(".tari div:nth-of-type(" + (this.indexTabel + 1) + ")").classList.remove("tariSelectate");
                        }
                        event.path[0].classList.add("tariSelectate");
                        this.indexTabel = i;
                    }
                }
            }

            colorBack(event) {
                event.path[0].classList.remove("tariSelectate");
            }

            keyCode(event) {
                var key = event.which || event.keyCode;
                var inputUser = {"label": this.$.filter.value, "value": this.$.filter.value};
                if (this.elemRamase.length !== 0) {
                    if (key === 40) {
                        if (this.indexTabel !== -1) {
                            this.shadowRoot.querySelector(".tari div:nth-of-type(" + (this.indexTabel + 1) + ")").classList.remove("tariSelectate");
                        }
                        this.indexTabel++;

                        if (this.indexTabel >= this.elemRamase.length) {
                            this.indexTabel = 0;
                        }

                        this.shadowRoot.querySelector(".tari").classList.add("displayTari");
                        this.shadowRoot.querySelector(".tari div:nth-of-type(" + (this.indexTabel + 1) + ")").classList.add("tariSelectate");
                    }

                    if (key === 38) {
                        if (this.indexTabel === -1) {
                            this.indexTabel = this.elemRamase.length;
                        }
                        if (this.indexTabel !== this.elemRamase.length) {
                            this.shadowRoot.querySelector(".tari div:nth-of-type(" + (this.indexTabel + 1) + ")").classList.remove("tariSelectate");
                        }
                        this.indexTabel--;

                        if (this.indexTabel <= -1) {
                            this.indexTabel = this.elemRamase.length - 1;
                        }
                        this.shadowRoot.querySelector(".tari").classList.add("displayTari");
                        this.shadowRoot.querySelector(".tari div:nth-of-type(" + (this.indexTabel + 1) + ")").classList.add("tariSelectate");
                    }
                }

                if (key === 13) {
                    if (this.elemRamase.length !== 0 && this.indexTabel === -1 && this.$.filter.value === "") {
                        this.indexTabel = 0;
                        this.styleDisplay();
                    } else if (this.elemRamase.length !== 0 && this.indexTabel !== -1) {
                        this.selectFunction({
                            model: {
                                item: this.elemRamase[this.indexTabel]
                            }
                        });
                        this.filter();
                        this.displayNone();
                        this.indexTabel = -1;
                        if (this.shadowRoot.querySelector(".tariSelectate") !== null) {
                            this.shadowRoot.querySelector(".tariSelectate").classList.remove("tariSelectate");
                        }
                    } else if (this.freetext) {
                        this.selectFunction({
                            model: {
                                item: this.$.filter.value
                            }
                        });
                        this.filter();
                        this.displayNone();
                        this.indexTabel = -1;
                        if (this.shadowRoot.querySelector(".tariSelectate") !== null) {
                            this.shadowRoot.querySelector(".tariSelectate").classList.remove("tariSelectate");
                        }

                    }

                }

                if (key === 8) {
                    if (this.multiple === true && this.combo === false) {
                        if (this._value.length !== 0 && this.$.filter.value === "") {
                            this.push("elemRamase", this._value[this._value.length - 1]);
                        }
                        this.orderList();
                    }
                    if (this._value.length > 0 && this.$.filter.value === "") {
                        this.splice("_value", this._value.length - 1, 1);
                        if(this._value.length === 0){
                            this.displayNone();
                        }
                        this.indexTabel = -1;
                        this.throwEvent();
                    }
                    if(this._value.length !== 0 || this.$.filter.value !== ""){
                        this.propInput = true;
                    }else{
                        this.propInput = false;
                    }
                }
            }

            filter(event) {
                this.styleDisplay();
                let val = this.$.filter.value;
                this.elemRamase = [];
                for (let i = 0; i < this.memArray.length; i++) {
                    if (this.memArray[i].label.toLowerCase().indexOf(val.toLowerCase()) !== -1) {
                        if (this.multiple && !this.combo) {
                            let found = false;
                            for (let x = 0; x < this._value.length; x++) {
                                if (this.memArray[i].value === this._value[x].value) {
                                    found = true;
                                    break;
                                }
                            }
                            if (found) {
                                continue;
                            }
                        }
                        this.push("elemRamase", this.memArray[i]);
                    }
                }
                this.orderList();
                this.styleDisplay();
            }

            selectFunction(event) {
                this.$.filter.value = "";
                let found = false;
                if (this.multiple === true) {
                    for (let i = 0; i < this.memArray.length; i++) {
                        if (typeof event.model.item !== 'undefined') {
                            if (this.memArray[i].value === event.model.item.value) {
                                this.push("_value", event.model.item);
                                //this.push("value", event.model.item.value);
                                this.throwEvent();
                                found = true;
                                break;
                            }
                        }
                    }
                    if (!found && this.freetext) {
                        this.push("_value", {
                            value: event.model.item,
                            label: event.model.item
                        });
                        //this.push("value", event.model.item);
                        this.throwEvent();
                    }
                } else {
                    for (let i = 0; i < this.memArray.length; i++) {
                        if (typeof event.model.item !== 'undefined') {
                            if (this.memArray[i].value === event.model.item.value) {
                                this._value = [event.model.item];
                                //this.value = [event.model.item.value];
                                this.throwEvent();
                                found = true;
                                break;
                            }
                        }
                    }
                    if (!found && this.freetext) {
                        this._value = [{
                            value: event.model.item,
                            label: event.model.item
                        }];
                       // this.value = [event.model.item];
                        this.throwEvent();
                    }
                }


                if (this.multiple === true && this.combo === false) {
                    this.elemRamase = [];
                    for (let i = 0; i < this.memArray.length; i++) {
                        let found = false;
                        for (let x = 0; x < this._value.length; x++) {
                            if (this.memArray[i].value === this._value[x].value) {
                                found = true;
                                break;
                            }
                        }
                        if (!found) {
                            this.push("elemRamase", this.memArray[i]);
                        }
                    }
                    //this.memArray = this.elemRamase;
                }

                setTimeout(function () {
                    this.$.filter.focus();
                }.bind(this));

                this.orderList();
            }

            delete(event) {

                this.splice("_value", event.model.index, 1);
                if (this.multiple === true && this.combo === false) {
                    this.push("elemRamase", event.model.item);
                    if (!this.options.includes(event.model.item) && this.freetext === true) {
                        this.push("options", event.model.item);
                    }

                }
                this.orderList();
                if(this._value.length !== 0 || this.$.filter.value !== ""){
                    this.propInput = true;
                }else{
                    this.propInput = false;
                }
                this.throwEvent();
            }
        }

        window.customElements.define(CbnSelect.is, CbnSelect);
    </script>
</dom-module>
