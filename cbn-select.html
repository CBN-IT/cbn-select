<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../cbn-icons/cbn-icons.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-input/paper-input-container.html">
<link rel="import" href="../iron-dropdown/iron-dropdown.html">


<dom-module id="cbn-select">
    <template>
        <style>
            :host {
                display: block;
                position:relative;
            }

            #filter {
                border: none;
                margin-bottom: 6px;
                position: relative;
                display: inline-block;
                height: 20px;
                outline: none;
                min-width: var(--cbn-select-filter-min-width,100px);
                flex: 1;
            }

            .tari {
                border: none;
                background-color: whitesmoke;
                z-index: 100;
                cursor: pointer;
            }

            .tariSelectate {
                background-color: darkgrey;
                width: 100%;
            }

            .arrow-left {
                width: 0;
                height: 0;
                border-top: 5px solid transparent;
                border-bottom: 5px solid transparent;
                border-right: 10px solid black;
                z-index: 1;
                position: absolute;
                right: 12px;
                top: -24px;
                transition: transform 0.5s;
            }

            .arrow-down {
                transform: rotate(-90deg);
            }

            .spanPrincipal {
                position: relative;
                padding-right: 30px;
                background-color: #E7E7E7;
                border-radius: 8px;
                display: inline-block;
                height: 20px;
                z-index: 1;
                white-space: nowrap;
                margin-top: 3px;
            }

            .closeBtn {
                flex-shrink: 0;
                width: 20px;
                height: 16px;
                margin-left: 3px;
                cursor: pointer;
                position: absolute;
                top: 2px;
                right: 0px;
            }

            .container {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
            }

            .fiecareDiv {
                padding: 5px 10px;
                box-sizing: border-box;
            }

            .linieLabel {
                top: -27px;
            }

            input.my-input {
                @apply --paper-input-container-shared-input-style;
            }

            #ironDropdown {
                padding: 5px;
            }

            #select {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                z-index: 2;
                opacity: 0.000001;
                outline:none;
                border:none;
            }
            [hidden]{
                display: none !important;
            }

        </style>

        <paper-input-container always-float-label="[[propInput]]" no-label-float="[[noLabelFloat]]"
                               disabled$="[[disabled]]" tabindex="0" style="outline:none">
            <label class="label" slot="label">[[label]]</label>
            <div class="container" slot="input" style="position:relative;">

                <template is="dom-repeat" items="{{_value}}">
                    <span class="spanPrincipal" for="spanPrincipal">
                        <span id="spanPrincipal" style="padding-left: 5px;">[[item.label]]</span>
                        <iron-icon class="closeBtn" icon="backspace" on-click="delete"></iron-icon>
                    </span>
                </template>
                <input class="my-input" id="filter" type="text" for="tari" on-input="filter" on-keydown="keyCode"/>

            </div>
            <div slot="input" style="position:relative;">
                <div class="arrow-left"></div>
            </div>
            <iron-dropdown slot="input" id="ironDropdown" no-cancel-on-outside-click horizontal-align="left"
                           vertical-align="top" vertical-offset="58" allow-outside-scroll="true">
                <div slot="dropdown-content" class="tari" on-mouseover="changeColor" on-mouseout="colorBack">
                    <template is="dom-repeat" items="{{_filteredOptions}}">
                        <div class="fiecareDiv" on-click="selectFunction">[[item.label]]</div>
                    </template>
                </div>
            </iron-dropdown>
        </paper-input-container>
        <select id="select" hidden$="[[isSelectHidden(mobile,freeText)]]" multiple="[[multiple]]" on-change="onchange"></select>
    </template>

    <script>
        /**
         * `cbn-select`
         *
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class CbnSelect extends Polymer.Element {
            static get is() {
                return 'cbn-select';
            }

            static get properties() {
                return {

                    label: {
                        type: String

                    },
                    name: {
                        type: String
                    },
                    indexTabel: {
                        type: Number,
                        value: -1
                    },

                    options: {
                        type: Array,
                        value: function () {
                            return []
                        },
                        observer: "optionsChange"
                    },

                    _filteredOptions: {
                        type: Array,
                        value: function () {
                            return []
                        }
                    },

                    value: {
                        type: Array,
                        notify: true,
                        observer: "valueChange",

                    },

                    _value: {
                        type: Array,
                        value: function () {
                            return []
                        },
                        notify: false,
                        readOnly: false
                    },

                    _options: {
                        type: Array,
                        value: function () {
                            return []
                        }
                    },

                    multiple: {
                        type: Boolean,
                        value: false
                    },

                    combo: {
                        type: Boolean,
                        value: false
                    },

                    freeText: {
                        type: Boolean,
                        value: false
                    },

                    noLabelFloat: {
                        type: Boolean,
                        value: false
                    },

                    mobile: {
                        type: Boolean,
                        value: function () {
                            const ua = window.navigator.userAgent;
                            return (/[mM]obi/i.test(ua) || /[tT]ablet/i.test(ua) || /[aA]ndroid/i.test(ua));
                        }
                    },

                    itemLabelProperty: {
                        type: String,
                        value: "label"
                    },
                    itemValueProperty: {
                        type: String,
                        value: "value"
                    },
                    required: {
                        type: Boolean,
                        value: false
                    },
                    disabled: {
                        type: Boolean,
                        value: false
                    },
                    noFilter: {
                        type: Boolean,
                        value: false
                    },
                    propInput: {
                        type: Boolean,
                        value: false
                    },
                    styleDisplayFunction: {
                        type: Function,
                        value: function () {
                            return function () {
                                this.styleDisplay()
                            }.bind(this);
                        }
                    },
                    styleDisplayNoneFunction: {
                        type: Function,
                        value: function () {
                            return function () {
                                this.displayNone()
                            }.bind(this);
                        }
                    },
                    _stopValueChange:{
                        type: Boolean,
                        value: false
                    }
                };
            }


            connectedCallback() {
                super.connectedCallback();
                this.addEventListener("focus", this.styleDisplayFunction);
                this.addEventListener("blur", this.styleDisplayNoneFunction);
            }

            disconnectedCallback() {
                super.connectedCallback();
                this.removeEventListener("focus", this.styleDisplayFunction);
                this.removeEventListener("blur", this.styleDisplayNoneFunction);
            }

            validate() {
                if (this.disabled) {
                    return true;
                }
                return !(this.required && this.value.length <= 0);
            }

            valueChange(event) {
                if(this._stopValueChange){
                    this._stopValueChange=false;
                    return;
                }
                let valueBackup = this._value;
                this._value = [];
                if (this.value instanceof Array) {
                    for (let i = 0; i < this.value.length; i++) {
                        let position = 0;
                        if (this.multiple === true || this.combo === false) {
                            position = this._value.length;
                        }
                        if (this.multiple === false && this.combo === true) {
                            position = 0;
                        }
                        if (typeof this.value[i] === "string") {
                            let found = false;
                            for (let j = 0; j < this._options.length; j++) {
                                if (this.value[i] === this._options[j].value) {
                                    this.splice("_value", position, 0, this._options[j]);
                                    found = true;
                                }
                            }
                            if (!found) {
                                for (let j = 0; j < valueBackup.length; j++) {
                                    if (this.value[i] === valueBackup[j].value) {
                                        this.splice("_value", position, 0, valueBackup[j]);
                                        found = true;
                                    }
                                }
                            }

                            if (this.freeText && !found) {
                                this.splice("_value", position, 0, {
                                    label: this.value[i],
                                    value: this.value[i]
                                });
                            }
                        } else {
                            let itemValueProp = "value";
                            let itemLabelProp = "label";

                            if (this.itemLabelProperty !== null && this.value[i].hasOwnProperty(this.itemLabelProperty)) {
                                itemLabelProp = this.itemLabelProperty;
                            }
                            if (this.itemValueProperty !== null && this.value[i].hasOwnProperty(this.itemValueProperty)) {
                                itemValueProp = this.itemValueProperty;
                            }

                            this.splice("_value", position, 0, this.value[i]);
                            if (this.multiple === true && this.combo === false) {
                                let object = {
                                    "label": this.value[i][itemLabelProp],
                                    "value": this.value[i][itemValueProp]
                                };
                                this.push("_options", object);
                            }
                        }
                    }
                } else {
                    if (typeof this.value === "string" && this.value.length > 0) {
                        let found = false;
                        for (let j = 0; j < this._options.length; j++) {
                            if (this.value === this._options[j].value) {
                                this.splice("_value", 0, 0, this._options[j]);
                                found = true;
                            }
                        }
                        if (this.freeText && !found) {
                            this.splice("_value", 0, 0, {
                                label: this.value,
                                value: this.value
                            });
                        }
                    } else if (this.value.length > 0) {
                        let position = 0;
                        if (this.multiple === true || this.combo === false) {
                            position = this._value.length;
                        }
                        if (this.multiple === false && this.combo === true) {
                            position = 0;
                        }
                        let itemValueProp = "value";
                        let itemLabelProp = "label";

                        if (this.itemLabelProperty !== null && this.value.hasOwnProperty(this.itemLabelProperty)) {
                            itemLabelProp = this.itemLabelProperty;
                        }
                        if (this.itemValueProperty !== null && this.value.hasOwnProperty(this.itemValueProperty)) {
                            itemValueProp = this.itemValueProperty;
                        }
                        this.splice("_value", position, 0, {
                            "label": this.value[itemLabelProp],
                            "value": this.value[itemValueProp]
                        });
                        if (this.multiple === true && this.combo === false) {
                            var object = {
                                "label": this.value[itemLabelProp],
                                "value": this.value[itemValueProp]
                            };
                            this.push("_options", object);
                        }
                    }
                }
                this.updateLabel();
                this.throwEvent();

            }

            throwEvent() {
                let value = "";
                if (this._value === undefined || this._value === null) {
                    if (this.multiple) {
                        value = [];
                    } else {
                        value = "";
                    }
                } else if (this.multiple) {
                    let val = [];
                    for (let i = 0; i < this._value.length; i++) {
                        val.push(this._value[i].value);
                    }
                    value = val;
                } else if (this._value.length > 0) {
                    value = this._value[0].value;
                } else {
                    value = "";
                }
                this.updateLabel();

                if(this.value !== value){
                this._stopValueChange=true;
                }
                this.dispatchEvent(new CustomEvent("cbn-selected-changed", {
                    bubbles: true,
                    composed: true,
                    detail: {
                        value: value,
                        fullValue: this._value
                    }
                }));
                this.value = value;
            }

            optionsChange() {
                let memArrayNew = [];
                for (let i = 0; i < this.options.length; i++) {
                    if (typeof this.options[i] === 'string') {
                        memArrayNew[i] = {"label": this.options[i], "value": this.options[i]};
                    } else {
                        memArrayNew[i] = JSON.parse(JSON.stringify(this.options[i]));
                        if (this.itemValueProperty !== null && this.options[i].hasOwnProperty(this.itemValueProperty)) {
                            memArrayNew[i]["value"] = this.options[i][this.itemValueProperty];
                        }
                        if (this.itemLabelProperty !== null && this.options[i].hasOwnProperty(this.itemLabelProperty)) {
                            memArrayNew[i]["label"] = this.options[i][this.itemLabelProperty];
                        }
                    }
                }

                this._options = memArrayNew;
                this._filteredOptions = JSON.parse(JSON.stringify(memArrayNew));
                this.orderList();
            }

            orderList() {
                this._filteredOptions.sort(
                    function (a, b) {
                        a.label = (a.label === undefined) ? "" : a.label;
                        b.label = (b.label === undefined) ? "" : b.label;

                        return a.label.toLowerCase().localeCompare(b.label.toLowerCase());
                    }
                );
                if (!this.isSelectHidden()) {
                    let str = "";
                    if(!this.multiple){
                        str = "<option value=''></option>";
                    }
                    for(let i=0;i<this._filteredOptions.length;i++){
                        str+=`<option value='${this._filteredOptions[i].value}'>${this._filteredOptions[i].label}</option>`
                    }
                    this.$.select.innerHTML=str;
                }
                this.$.ironDropdown.notifyResize();
            }

            open(event) {
                this.$.ironDropdown.notifyResize();
                this.$.ironDropdown.open();
                this.updateLabel();
                this.$.filter.focus();
            }


            styleDisplay(event) {
                if (!this.isSelectHidden()) {
                    return;
                }
                this.open();
                if (this.indexTabel === -1) {
                    this.indexTabel = 0;
                }
                this.shadowRoot.querySelector(".arrow-left").classList.add("arrow-down");
                setTimeout(function () {
                    if (this._filteredOptions.length > this.indexTabel && this.shadowRoot.querySelector(".tari div:nth-of-type(" + (this.indexTabel + 1) + ")") !== null) {
                        this.shadowRoot.querySelector(".tari div:nth-of-type(" + (this.indexTabel + 1) + ")").classList.add("tariSelectate");
                    }
                }.bind(this));
            }

            displayNone(event) {
                this.shadowRoot.querySelector(".arrow-left").classList.remove("arrow-down");
                this.$.ironDropdown.close();
                if (this.shadowRoot.querySelector(".tari div:nth-of-type(" + (this.indexTabel + 1) + ")") !== null) {
                    this.shadowRoot.querySelector(".tari div:nth-of-type(" + (this.indexTabel + 1) + ")").classList.remove("tariSelectate");
                }
                this.indexTabel = -1;
                if (this.freeText && this.$.filter.value.length > 0) {
                    this.selectFunction({
                        model: {
                            item: this.$.filter.value,
                        }
                    });
                }
            }

            getFocus(event) {
                event.path[0].parentNode.querySelector("#filter").focus();
            }

            changeColor(event) {
                for (let i = 0; i < this._filteredOptions.length; i++) {
                    if (event.path[0].innerHTML === this._filteredOptions[i].label) {
                        if (this.indexTabel !== -1) {
                            this.shadowRoot.querySelector(".tari div:nth-of-type(" + (this.indexTabel + 1) + ")").classList.remove("tariSelectate");
                        }
                        event.path[0].classList.add("tariSelectate");
                        this.indexTabel = i;
                    }
                }
            }

            colorBack(event) {
                event.path[0].classList.remove("tariSelectate");
            }

            keyCode(event) {
                var key = event.which || event.keyCode;
                var inputUser = {"label": this.$.filter.value, "value": this.$.filter.value};
                if (this._filteredOptions.length !== 0) {
                    if (key === 40/*arrow down*/) {
                        if (this.indexTabel !== -1) {
                            this.shadowRoot.querySelector(".tari div:nth-of-type(" + (this.indexTabel + 1) + ")").classList.remove("tariSelectate");
                        }
                        this.indexTabel++;

                        if (this.indexTabel >= this._filteredOptions.length) {
                            this.indexTabel = 0;
                        }

                        this.open();
                        this.shadowRoot.querySelector(".tari div:nth-of-type(" + (this.indexTabel + 1) + ")").classList.add("tariSelectate");
                    }

                    if (key === 38/*arrow up*/) {
                        if (this.indexTabel === -1) {
                            this.indexTabel = this._filteredOptions.length;
                        }
                        if (this.indexTabel !== this._filteredOptions.length) {
                            this.shadowRoot.querySelector(".tari div:nth-of-type(" + (this.indexTabel + 1) + ")").classList.remove("tariSelectate");
                        }
                        this.indexTabel--;

                        if (this.indexTabel <= -1) {
                            this.indexTabel = this._filteredOptions.length - 1;
                        }
                        this.open();
                        this.shadowRoot.querySelector(".tari div:nth-of-type(" + (this.indexTabel + 1) + ")").classList.add("tariSelectate");
                    }
                }

                if (key === 13/*enter*/) {
                    if (this._filteredOptions.length !== 0 && this.indexTabel === -1 && this.$.filter.value === "") {
                        this.indexTabel = 0;
                        this.styleDisplay();
                    } else if (this._filteredOptions.length !== 0 && this.indexTabel !== -1) {
                        this.selectFunction({
                            model: {
                                item: this._filteredOptions[this.indexTabel],
                            }
                        });
                        this.filter();
                        this.displayNone();
                        this.indexTabel = -1;
                        if (this.shadowRoot.querySelector(".tariSelectate") !== null) {
                            this.shadowRoot.querySelector(".tariSelectate").classList.remove("tariSelectate");
                        }
                    } else if (this.freeText && this.$.filter.value !== "") {
                        this.selectFunction({
                            model: {
                                item: this.$.filter.value,
                            }
                        });
                        this.filter();
                        this.displayNone();
                        this.indexTabel = -1;
                        if (this.shadowRoot.querySelector(".tariSelectate") !== null) {
                            this.shadowRoot.querySelector(".tariSelectate").classList.remove("tariSelectate");
                        }

                    }
                }

                if (key === 8/*backspace*/) {
                    if (this.multiple === true && this.combo === false) {
                        if (this._value.length !== 0 && this.$.filter.value === "") {
                            this.push("_filteredOptions", this._value[this._value.length - 1]);
                        }
                        this.orderList();
                    }
                    if (this._value.length > 0 && this.$.filter.value === "") {
                        this.splice("_value", this._value.length - 1, 1);
                        if (this._value.length === 0) {
                            this.displayNone();
                        }
                        this.indexTabel = -1;
                        this.throwEvent();
                    }
                    this.updateLabel();
                }
            }

            updateLabel() {
                this.propInput = this._value.length !== 0 || this.$.filter.value !== "";
            }

            filter(event) {
                if (this.noFilter) {
                    return;
                }
                this.styleDisplay();
                let val = this.$.filter.value;
                this._filteredOptions = [];
                for (let i = 0; i < this._options.length; i++) {
                    if (this._options[i].label.toLowerCase().indexOf(val.toLowerCase()) !== -1) {
                        if (this.multiple && !this.combo) {
                            let found = false;
                            for (let x = 0; x < this._value.length; x++) {
                                if (this._options[i].value === this._value[x].value) {
                                    found = true;
                                    break;
                                }
                            }
                            if (found) {
                                continue;
                            }
                        }
                        this.push("_filteredOptions", this._options[i]);
                    }
                }
                this.orderList();
                this.styleDisplay();
            }

            selectFunction(event) {
                this.$.filter.value = "";
                let found = false;
                if (this.multiple === true) {
                    for (let i = 0; i < this._options.length; i++) {
                        if (typeof event.model.item !== 'undefined') {
                            if (this._options[i].value === event.model.item.value) {

                                this.push("_value", event.model.item);
                                this.throwEvent();
                                found = true;
                                break;
                            }
                        }
                    }
                    if (!found && this.freeText) {
                        if (typeof event.model.item === "string") {
                            this.push("_value", {
                                value: event.model.item,
                                label: event.model.item
                            });
                            let object = {
                                "label": event.model.item,
                                "value": event.model.item
                            };
                            this.push("_options", object);
                        } else {
                            this.push("_value", event.model.item);
                            let object = event.model.item;
                            this.push("_options", object);
                        }

                        this.throwEvent();
                    }
                } else {
                    for (let i = 0; i < this._options.length; i++) {
                        if (typeof event.model.item !== 'undefined') {
                            if (this._options[i].value === event.model.item.value) {
                                this._value = [event.model.item];
                                //this.value = [event.model.item.value];
                                this.throwEvent();
                                found = true;
                                break;
                            }
                        }
                    }
                    if (!found && this.freeText) {
                        this._value = [{
                            value: event.model.item,
                            label: event.model.item
                        }];
                        if (!this.combo) {
                            var object = {
                                "label": event.model.item,
                                "value": event.model.item
                            };
                            this.push("_options", object);
                        }
                        this.throwEvent();
                    }
                }


                if (this.multiple === true && this.combo === false) {
                    this._filteredOptions = [];
                    for (let i = 0; i < this._options.length; i++) {
                        let found = false;
                        for (let x = 0; x < this._value.length; x++) {
                            if (this._options[i].value === this._value[x].value) {
                                found = true;
                                break;
                            }
                        }
                        if (!found) {
                            this.push("_filteredOptions", this._options[i]);
                        }
                    }
                }

                setTimeout(function () {

                    if (!this.multiple) {
                        this.blur();
                    }

                }.bind(this));

                this.orderList();
                this.indexTabel = -1;
            }

            delete(event) {
                this.splice("_value", event.model.index, 1);
                if (this.multiple === true && this.combo === false) {
                    this.push("_filteredOptions", event.model.item);
                    if (!this.options.includes(event.model.item) && this.freeText === true) {
                        this.push("options", event.model.item);
                    }
                }
                this.orderList();
                this.throwEvent();
            }
            onchange(event){
                let result = [];
                let options = this.$.select.options;
                let opt;

                for (let i=0, iLen=options.length; i<iLen; i++) {
                    opt = options[i];

                    if (opt.selected) {
                        result.push(opt.value || opt.text);
                    }
                }
                let _value=[];
                for(let j=0;j<result.length;j++){
                    for (let i = 0; i < this._options.length; i++) {
                        if (this._options[i].value === result[j]) {
                            _value.push(this._options[i]);
                            break;
                        }
                    }
                }
                this._value=_value;
                this.throwEvent();

                console.log(result) ;
            }

            isSelectHidden() {
                return !this.mobile || this.freeText
            }
        }

        window.customElements.define(CbnSelect.is, CbnSelect);
    </script>
</dom-module>
